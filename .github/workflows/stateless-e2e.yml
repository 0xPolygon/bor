name: Stateless Sync Tests

on:
  push:
    branches:
      - 'stateless_sync'
  pull_request:
    branches:
      - 'stateless_sync'
    types: [opened, synchronize, reopened]

concurrency:
  group: stateless-sync-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  ENCLAVE_NAME: stateless-sync-e2e

jobs:
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # Try to free up disk space (around 6 GB) before running the kurtosis job.
      # This is needed because the job fails with "System.IO.IOException: No space left on device".
      - name: Free disk space
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be # 2023/10/19
        with:
          tool-cache: true

      - name: Checkout Bor
        uses: actions/checkout@v4
        with:
          path: bor

      - name: Install dependencies on Linux
        if: runner.os == 'Linux'
        run: sudo apt update && sudo apt install build-essential

      - name: Pre kurtosis run
        uses: ./bor/.github/actions/kurtosis-pre-run

      # Build Bor image from current branch for stateless sync feature.
      - name: Build Bor Docker Image (stateless_sync)
        run: |
          cd bor
          git branch --show-current
          docker build -t bor:stateless_sync --file Dockerfile .

      - name: Checkout Heimdall-v2
        uses: actions/checkout@v4
        with:
          repository: 0xPolygon/heimdall-v2
          ref: stateless_sync
          path: heimdall-v2

      # # Build Heimdall-v2 image from stateless_sync branch.
      - name: Build Heimdall-v2 Docker Image (stateless_sync)
        run: |
          cd heimdall-v2
          docker build -t heimdall-v2:stateless_sync --file Dockerfile .

      - name: Checkout Kurtosis
        uses: actions/checkout@v4
        with:
          repository: 0xPolygon/kurtosis-polygon-pos
          ref: stateless
          path: kurtosis-polygon-pos

      - name: Copy kurtosis config
        run: cp ./bor/.github/configs/stateless-e2e.yml ./kurtosis-polygon-pos/stateless-e2e.yml

      - name: Kurtosis run
        run: |
          cd kurtosis-polygon-pos
          kurtosis run --args-file stateless-e2e.yml --enclave ${{ env.ENCLAVE_NAME }} .

      - name: Inspect enclave
        run: |
          cd kurtosis-polygon-pos
          kurtosis enclave inspect ${{ env.ENCLAVE_NAME }}

      - name: Test state syncs
        run: kurtosis service exec ${{ env.ENCLAVE_NAME }} test-runner "bats --filter-tags pos,bridge,matic,pol --recursive tests/"

      - name: Post kurtosis run
        if: always()
        uses: ./bor/.github/actions/kurtosis-post-run
        with:
          enclave_name: ${{ env.ENCLAVE_NAME }}
